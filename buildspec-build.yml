# buildspec-build.yml

version: 0.2

# Environment variables and values used across phases
env:
  variables:
    # ECR URI where Docker image will be pushed
    IMAGE_URI: "820825185444.dkr.ecr.ap-northeast-2.amazonaws.com/aws-eks-devops-test"
  exported-variables:
    # Variables that will be shared with downstream phases or pipelines
    - IMAGE_URI
    - GITHUB_COMMIT_CODE
    - IMAGE_TAG

phases:
  install:
    commands:
      # Install phase (empty here since the CodeBuild image has necessary tools)
      - echo "Install Phase - Nothing to do using latest Amazon Linux Docker Image"

  pre_build:
    commands:
      # Generate a short Docker image tag using GitHub commit SHA (7 characters)
      - GITHUB_COMMIT_CODE="$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c1-7)"
      - echo "CODEBUILD_BUILD_NUMBER=${CODEBUILD_BUILD_NUMBER}"
      - IMAGE_TAG="${GITHUB_COMMIT_CODE}-${CODEBUILD_BUILD_NUMBER}.0"
      - export IMAGE_TAG
      # Authenticate Docker with ECR using AWS CLI
      - echo "Logging into Amazon ECR at $IMAGE_URI..."
      - aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin $IMAGE_URI

  build:
    commands:
      # Build Docker image using Dockerfile in root directory
      - echo "Building Docker image..."
      - docker build -t $IMAGE_URI:$IMAGE_TAG .

      # >>> Start: manifest image: value change <<<
      - echo "Updating image tag in Kubernetes manifest..."
      - MANIFEST_FILE="kube-manifests/01-DEVOPS-Nginx-Deployment.yml"
      # image: line overwrite (code indentation). GNU sed.
      - sed -Ei 's|^( *image:).*|\1 '"$IMAGE_URI:$IMAGE_TAG"'|' "$MANIFEST_FILE"
      # log output 
      - echo "[Verify] Updated image line:"
      - grep -nE 'image:' "$MANIFEST_FILE" || true
      # >>> The End <<<

  post_build:
    commands:
      # Push the built Docker image to ECR repository
      - echo "Pushing Docker image to ECR..."
      - docker push $IMAGE_URI:$IMAGE_TAG
      # Export image metadata to be used in the deploy stage
      - echo "Exporting variables for downstream stages..."
      - echo "IMAGE_URI=$IMAGE_URI" >> $CODEBUILD_SRC_DIR/exported-vars.env
      #- echo "GITHUB_COMMIT_CODE=$GITHUB_COMMIT_CODE" >> $CODEBUILD_SRC_DIR/exported-vars.env
      - echo "IMAGE_TAG=$IMAGE_TAG" >> $CODEBUILD_SRC_DIR/exported-vars.env

# Files that will be included as artifacts for the next stage
artifacts:
  files:
    - exported-vars.env
    - buildspec-deploy.yml
    - '**/kube-manifests/**/*'
